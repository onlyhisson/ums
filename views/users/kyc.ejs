<!DOCTYPE html>
<html lang="en">
<head>
  <%- include ../_incl/inc_header.ejs %>
</head>
<body class="hold-transition skin-black sidebar-mini">
<div class="wrapper">

  <%- include ../_incl/inc_top.ejs %>
  <%- include ../_incl/inc_submenu.ejs %>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h1>
        <%=title%>
      </h1>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="#"><i class="fa fa-cc-mastercard"></i> KYC</a></li>
        <li class="breadcrumb-item active">KYC 인증 신청</li>
      </ol>
    </section>

    <!-- Main content -->
    <section class="content">
     
     <!-- Basic Forms -->
      <div class="box">
        <div class="box-header with-border">
			<h3 class="box-title">KYC 인증 신청</h3>
			<h6 class="box-subtitle">
				<span id="is_kyc" class="text-danger"></span> 
				<a href="http://reactiveraven.github.io/jqBootstrapValidation/"> <span class="text-cyan">[참고]</span></a>
			</h6>

          <div class="box-tools pull-right">
            <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
            <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-remove"></i></button>
          </div>
        </div>
        <!-- /.box-header -->
        <div class="box-body">
          <div class="row">
            <div class="col">
            	<form>
					<div class="form-group">
						<h5>국적 <span class="text-danger">*</span></h5>
						<div class="controls">
							<select name="country" id="country" required class="form-control">
								<option value="">국적</option>
								<option value="HKG">중국 홍콩</option>
								<option value="CHN">중국</option>
								<option value="OMA">중국 마카오</option>
								<option value="TPE">대만</option>
								<option value="KOR" selected="">한국</option>
								<option value="JPN">일본</option>
								<option value="SIN">싱가포르</option>
								<option value="AUS">호주</option>
								<option value="USA">미국</option>
								<option value="GBR">영국</option>
							</select>
						</div>
					</div>

					<div class="row">

						<div class="col-md-3 col-12">
							<div class="form-group">
								<h5>지역 번호 <span class="text-danger">*</span></h5>
								<div class="controls">
									<select id="area_code" name="area_code" required class="form-control">
										<option value="">지역번호</option>
										<option value="852">+852</option>
										<option value="86">+86</option>
										<option value="853">+853</option>
										<option value="886">+886</option>
										<option value="82" selected="">+82</option>
										<option value="81">+81</option>
										<option value="65">+65</option>
										<option value="61">+61</option>
										<option value="1">+1</option>
										<option value="44">+44</option>
									</select>
								</div>
							</div>
						</div>

						<div class="col-md-9 col-12">
							<div class="form-group">
								<h5>휴대폰 번호 <span class="text-danger">*</span></h5>
								<div class="controls">
									<div class="input-group">
										<div class="input-group-prepend">
											<div class="input-group-text">
												<i class="fa fa-phone"></i>
											</div>
										</div>
										<input type="text" id="mobile" name="mobile" class="form-control" required data-validation-required-message="This field is required" data-inputmask="'mask':[ '999-9999-9999' ]" data-mask>
									</div>
								</div>
							</div>
						</div>

					</div>



					<div class="form-group">
						<h5>성 <span class="text-danger">*</span></h5>
						<div class="controls">
							<input type="text" name="last_name" id="last_name" class="form-control" required data-validation-required-message="This field is required">
						</div>
					</div>

					<div class="form-group">
						<h5>이름 <span class="text-danger">*</span></h5>
						<div class="controls">
							<input type="text" name="first_name" id="first_name" class="form-control" required data-validation-required-message="This field is required">
						</div>
					</div>


					<div class="row">

						<div class="col-md-3 col-12">
							<div class="form-group">
								<h5>신분증 종류 <span class="text-danger">*</span></h5>
								<div class="controls">
									<select id="card_type" name="card_type" required class="form-control">
										<option value="0">신분증 번호</option>
										<option value="1" selected="">여권</option>
									</select>
								</div>
							</div>
						</div>

						<div class="col-md-9 col-12">
							<div class="form-group">
								<h5>ID Number<span class="text-danger">*</span></h5>
								<div class="controls">
									<div class="input-group">
										<div class="input-group-prepend">
											<div class="input-group-text">
												<i class="fa fa-id-card-o"></i>
											</div>
										</div>
										<input type="text" id="card_no" name="card_no" class="form-control" required data-validation-required-message="This field is required" placeholder="예) M65000000">
									</div>
								</div>
							</div>
						</div>

					</div>


					<div class="form-group">
						<h5>성별 <span class="text-danger">*</span></h5>
						<div class="controls">
							<select name="gender" id="gender" required class="form-control">
								<option value="M" selected="">남자</option>
								<option value="F">여자</option>
							</select>
						</div>
					</div>

					<div class="form-group">
						<h5>생년월일 <span class="text-danger">*</span></h5>
						<div class="controls">
							<div class="input-group">
								<div class="input-group-prepend">
									<div class="input-group-text">
										<i class="fa fa-calendar"></i>
									</div>
								</div>
							<input type="text" class="form-control" id="birthdate" required data-validation-required-message="This field is required" data-inputmask="'alias': 'yyyy/mm/dd'" data-mask>
							</div>
						</div>
					</div>
				
					<div class="form-group">
						<h5>주소 <span class="text-danger">*</span></h5>
						<div class="controls">
							<input type="text" id="address" name="address" class="form-control" placeholder="예) 851,269, Gosanja-ro, Seongdong-gu, Seoul, Republic of Korea"> 
						</div>
					</div>
				</form>

				<form class="kyc_auth_req">
					<div class="form-group">
						<h5>주소자료 <span class="text-danger">*</span><small> (파일 크기 <code>3Mb</code>이하)</small></span>
						<div class="controls">
							<div class="input-group input-file" name="Fichier1">
								<input type="text" id="address_pic" name="text" class="form-control selected_file" placeholder='주소 자료를 업로드 하세요.(주소가 보이는 신분증)' required> 
								<span class="input-group-btn">
									<button type="reset" class="btn btn-default border-danger del-file" >삭제</button>
									<button type="submit" class="btn btn-info">업로드</button>
								</span> 
							</div>
						</div>
					</div>
				</form>
				
				<form class="kyc_auth_req">
					<div class="form-group">
						<h5>
							여권 사본 
							<span class="text-danger">*</span>
							<small> 
								<a href="/images2/sample_passport.png" target="_blank" style="color:dodgerblue"> 샘플사진</a>
								(파일 크기 <code>3Mb</code>이하)
							</small>
						</h5>
						<div class="controls">
							<div class="input-group input-file" name="Fichier1">
								<input type="text" id="card_pic" name="text" class="form-control selected_file" placeholder='여권 사본을 업로드 하세요.' required> 
								<span class="input-group-btn">
									<button type="reset" class="btn btn-default border-danger del-file" >삭제</button>
									<button type="submit" class="btn btn-info">업로드</button>
								</span> 
							</div>
						</div>
					</div>
				</form>
				
				<form class="kyc_auth_req">
					<div class="form-group">
						<h5>
							여권 뒷면 사진 
							<small> (파일 크기 <code>3Mb</code>이하</small>)
						</h5>
						<div class="controls">
							<div class="input-group input-file" name="Fichier1">
								<input type="text" id="card_pic2" name="text" class="form-control selected_file" placeholder='중국 여권 소지자만 업로드 하세요.'> 
								<span class="input-group-btn">
									<button type="reset" class="btn btn-default border-danger del-file" >삭제</button>
									<button type="submit" class="btn btn-info">업로드</button>
								</span> 
							</div>
						</div>
					</div>
				</form>
				
				<form class="kyc_auth_req">
					<div class="form-group">
						<h5>
							여권 들고 찍은 사진 
							<span class="text-danger">*</span>
							<small> 
								<a href="/images2/sample_passport2.png" target="_blank" style="color:dodgerblue"> 샘플사진</a>
								(파일 크기 <code>3Mb</code>이하)
							</small>
						</h5>
						<div class="controls">
							<div class="input-group input-file" name="Fichier1">
								<input type="text" id="hand_pic" name="text" class="form-control selected_file" placeholder='여권을 들고 찍은 사진을 업로드하세요.' required> 
								<span class="input-group-btn">
									<button type="reset" class="btn btn-default border-danger del-file" >삭제</button>
									<button type="submit" class="btn btn-info">업로드</button>
								</span> 
							</div>
						</div>
					</div>
					
					<div class="bb-1 border-secondary h-30"></div><br>

					<div class="text-xs-right" style="padding-top: 30px;">
						<a href="javascript:void(0)" class="btn btn-lg btn-success go-kyc">확정</a>
						<span id="kyc_verification">* 필수 입력 항목을 모두 작성하세요.</span>
					</div>
				</form>
            	
            </div>
            <!-- /.col -->
          </div>
          <!-- /.row -->
        </div>
        <!-- /.box-body -->
      </div>
      <!-- /.box -->
      
    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->
  
   
  <%- include ../_incl/inc_footer.ejs %>
  <%- include ../_incl/inc_sidebar.ejs %>
  
</div>
<!-- ./wrapper -->

<%- include ../_incl/inc_scripts.ejs %>

	<script>
	let checkImages = {
		"address_pic": false,
		"card_pic": false,
		"hand_pic": false
	}

	const checkImageArray = [
		'address_pic',  // 주소 자료
		'card_pic',     // 여권 사본
		'hand_pic'      // 여권들고 찍은 사진
	]; 
	</script>

	<script>
	window.onload = function() { 
		$('#is_kyc').html(ums.kycStatus['<%=sess.is_kyc%>'])
	}
	</script>
	
	<script>
	/* 파일 업로드 Form 함수 */
	function bs_input_file() {
		$(".input-file").before(
			function() {
				if ( ! $(this).prev().hasClass('input-ghost') ) {
					var element = $("<input type='file' class='input-ghost' style='visibility:hidden; height:0'>");
					element.attr("name",$(this).attr("name"));
					element.change(function(){
						element.next(element).find('input').val((element.val()).split('\\').pop());
					});
					$(this).find("button.btn-choose").click(function(){
						element.click();
					});
					$(this).find("button.btn-reset").click(function(){
						element.val(null);
						$(this).parents(".input-file").find('input').val('');
					});
					$(this).find('input').css("cursor","pointer");
					$(this).find('input').mousedown(function() {
						$(this).parents('.input-file').prev().click();
						return false;
					});
					return element;
				}
			}
		);
	}

	$(function() {
		bs_input_file();
	});
	</script>

	<script>
		/* 파일 업로드 버튼 클릭 이벤트 */
		$('.kyc_auth_req').on("submit", function(e) {
		  e.preventDefault();

		  let uploadId = $(this).find('input[type=text]').attr('id');
		  let uploadBtn = $(this).find('button[type=submit]');
		  let selectedFile = $(this).find('.selected_file');
		  let formData = new FormData(this);
		  //formData.append('key', 'value');

		  uploadBtn.css('display', 'none');
  
		  if($(this).find('.input-ghost').val()){
			$.ajax({
			  type: "POST",
			  url: "/ajax/getImageUrl",
			  data: formData,
			  processData: false,
			  contentType: false,
			  success: function(data){
				if(data.status == '_success_' && data.picUrl !=''){
				  selectedFile.val(data.picUrl);
				  checkImages[uploadId] = true;
				  checkKycInfo();
				}else{
					toastAlert(data.msg, '', 'error')
				}
				uploadBtn.css('display', '');
			  },
			  error: function (e) {
				toastAlert(ums.error[1000], '[CODE] : '+data.code, 'error')
				uploadBtn.css('display', '');
			  }
			});
		  }else{
			uploadBtn.css('display', '');
			toastAlert(ums.error[2000], '', 'info')
		  }
		})
  
		/* 파일 삭제 버튼 클릭 이벤트 */
		$('.del-file').click(function() {
		  let removeImgOne = $(this).closest('.form-group').find('input[type=text]').attr('id')
		  checkImages[removeImgOne] = false;
		  checkKycInfo();
		})
	</script>
  
	<script>
		/* KYC 인증 신청 AJAX */
		$('.go-kyc').click(function(){

			if(!checkKycInfo())
			return;

			// 페이지로더 띄우기
			
			$.ajax({
			type: 'POST',
			url: '/users/ajax/kyc_auth',
			data: {
				country:$('#country').val(),
				area_code:$('#area_code').val(),
				mobile:$('#mobile').val(),
				first_name:$('#first_name').val(),
				last_name:$('#last_name').val(),
				card_type:$('#card_type').val(),
				card_no:$('#card_no').val(),
				gender:$('#gender').val(),
				birthdate:$('#birthdate').val(),
				address:$('#address').val(),
				address_pic:$('#address_pic').val(),
				card_pic:$('#card_pic').val(),
				card_pic2:$('#card_pic2').val(),
				hand_pic:$('#hand_pic').val()
			},
			success: function(data) {

					if(data.status =='_success_'){
						toastAlert(data.msg, '[CODE] : '+data.code, 'success')
					} else {
						toastAlert(data.msg, '[CODE] : '+data.code, 'error')
					}
				}
			})
		})
	</script>

	<script>
		/* 유효성 검증 */
		checkKycInfo = () => {
			if($('#country').val() == '') {
			$('#kyc_verification').html('* 국적을 선택하세요.');
			$('#kyc_verification').attr('class', 'text-danger')
			return false;
			}

			if($('#area_code').val() == '') {
			$('#kyc_verification').html('* 지역번호를 입력하세요.');
			$('#kyc_verification').attr('class', 'text-danger')
			return false;
			}

			if($('#mobile').val() == '') {
			$('#kyc_verification').html('* 휴대폰 번호를 입력하세요.');
			$('#kyc_verification').attr('class', 'text-danger')
			return false;
			}

			if($('#last_name').val() == '') {
			$('#kyc_verification').html('* 성을 입력하세요.');
			$('#kyc_verification').attr('class', 'text-danger')
			return false;
			}

			if($('#first_name').val() == '') {
			$('#kyc_verification').html('* 이름을 입력하세요.');
			$('#kyc_verification').attr('class', 'text-danger')
			return false;
			}

			if($('#card_no').val() == '') {
			$('#kyc_verification').html('* 여권번호를 입력하세요.');
			$('#kyc_verification').attr('class', 'text-danger')
			return false;
			}

			if($('#birthdate').val() == '') {
			$('#kyc_verification').html('* 생년월일을 입력하세요.');
			$('#kyc_verification').attr('class', 'text-danger')
			return false;
			}

			if($('#address').val() == '') {
			$('#kyc_verification').html('* 주소를 입력하세요.');
			$('#kyc_verification').attr('class', 'text-danger')
			return false;
			}

			return checkKycImage();
		};

		/* 이미지 업로드 유효성 검사 */
		checkKycImage = () => {
			return (checkImageArray.every(isImageUploaded));
		}

		/* 이미지 업로드 유효성 검사 */
		isImageUploaded = (item) => {
			let imgMsg = '*'+$('#'+item).attr('placeholder');
			$('#kyc_verification').html(imgMsg);
			$('#kyc_verification').attr('class', 'text-danger')
			return checkImages[item]
		}
	</script>
</body>
</html>
